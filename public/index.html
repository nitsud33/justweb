<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Collector Pro - Track Pokemon, MTG & Yu-Gi-Oh Cards</title>
  <meta name="description" content="Track your trading card collection across Pokemon, Magic: The Gathering, and Yu-Gi-Oh! Monitor prices, find trades, and complete your sets.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¥</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #ff6b35;
      --primary-dark: #e55a2b;
      --secondary: #3498db;
      --bg: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-input: #16213e;
      --text: #ffffff;
      --text-muted: #a0a0b0;
      --border: #2a2a4a;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, var(--bg-card), var(--bg-input));
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      cursor: pointer;
    }
    
    .logo span {
      font-size: 2rem;
    }
    
    nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    nav button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    nav button:hover, nav button.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .stats-bar {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .stats-bar .stat {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .stats-bar .stat-value {
      color: var(--primary);
      font-weight: bold;
    }
    
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* Auth Styles */
    .auth-container {
      max-width: 400px;
      margin: 4rem auto;
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    .auth-container h2 {
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    
    .btn-full {
      width: 100%;
      justify-content: center;
    }
    
    .google-btn {
      background: white;
      color: #333;
      margin-top: 1rem;
    }
    
    .auth-toggle {
      text-align: center;
      margin-top: 1rem;
      color: var(--text-muted);
    }
    
    .auth-toggle a {
      color: var(--primary);
      cursor: pointer;
    }
    
    /* Dashboard / Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .stat-card .stat-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-card .stat-value {
      font-size: 1.75rem;
      font-weight: bold;
    }
    
    .stat-card .stat-change {
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
    
    .stat-card .stat-change.positive {
      color: var(--success);
    }
    
    .stat-card .stat-change.negative {
      color: var(--danger);
    }
    
    /* Chart container */
    .chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .chart-container h3 {
      margin-bottom: 1rem;
    }
    
    .chart-container canvas {
      max-height: 300px;
    }
    
    /* Search Section */
    .search-section {
      margin-bottom: 2rem;
    }
    
    .search-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .search-bar input {
      flex: 1;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
    }
    
    .search-bar input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Card Grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
    }
    
    .card-item {
      background: var(--bg-card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }
    
    .card-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
      border-color: var(--primary);
    }
    
    .card-item img {
      width: 100%;
      aspect-ratio: 2.5/3.5;
      object-fit: contain;
      background: #1a1a2e;
    }
    
    .card-item .card-info {
      padding: 0.75rem;
    }
    
    .card-item .card-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .card-item .card-set {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    .card-item .card-price {
      font-weight: bold;
      color: var(--success);
    }
    
    .card-item .card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .card-item .card-actions button {
      flex: 1;
      padding: 0.4rem;
      font-size: 0.75rem;
    }
    
    .card-quantity {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .card-owned-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--success);
      color: white;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.65rem;
    }
    
    /* Set Browser */
    .set-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .set-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .set-item:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }
    
    .set-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }
    
    .set-item .set-info {
      flex: 1;
    }
    
    .set-item .set-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .set-item .set-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .set-item .set-progress {
      text-align: right;
    }
    
    .progress-bar {
      width: 80px;
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }
    
    .progress-bar-large {
      width: 100%;
      height: 20px;
      border-radius: 10px;
    }
    
    .progress-bar-large .progress-bar-fill {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      font-size: 1.25rem;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-card-detail {
      display: flex;
      gap: 1.5rem;
    }
    
    .modal-card-detail img {
      width: 200px;
      border-radius: 8px;
    }
    
    .modal-card-detail .detail-info {
      flex: 1;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .detail-row:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      color: var(--text-muted);
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    /* Page Headers */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .page-header h1 {
      font-size: 1.75rem;
    }
    
    .page-header-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    
    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    .loading::after {
      content: '';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-color: var(--success);
    }
    
    .toast.error {
      border-color: var(--danger);
    }
    
    /* Share Section */
    .share-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .share-url {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .share-url input {
      flex: 1;
      padding: 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: monospace;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    
    .tabs button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tabs button:hover, .tabs button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    /* Completion Cost Badge */
    .cost-badge {
      background: var(--warning);
      color: #000;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: bold;
      display: inline-block;
    }
    
    /* List Items */
    .list-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: var(--bg-input);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .list-item img {
      width: 50px;
      height: 70px;
      object-fit: contain;
      border-radius: 4px;
    }
    
    .list-item-info {
      flex: 1;
    }
    
    .list-item-name {
      font-weight: 600;
    }
    
    .list-item-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      nav {
        justify-content: center;
      }
      
      .stats-bar {
        display: none;
      }
      
      .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
      }
      
      .modal-card-detail {
        flex-direction: column;
      }
      
      .modal-card-detail img {
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
      }
      
      main {
        padding: 1rem;
      }
      
      .two-col {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Priority badges */
    .priority-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .priority-1 { background: var(--text-muted); }
    .priority-2 { background: var(--warning); }
    .priority-3 { background: var(--danger); }

    /* Rarity colors */
    .rarity-common { color: #a0a0a0; }
    .rarity-uncommon { color: #3498db; }
    .rarity-rare { color: #f39c12; }
    .rarity-holo { color: #9b59b6; }
    .rarity-ultra { color: #e74c3c; }
    .rarity-secret { color: #f1c40f; }

    /* Trade styles */
    .trade-tab { }
    
    .match-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    
    .match-card:hover {
      border-color: var(--primary);
    }
    
    .match-card.bidirectional {
      border-left: 4px solid var(--success);
    }
    
    .match-card.they_have {
      border-left: 4px solid var(--secondary);
    }
    
    .match-card.they_want {
      border-left: 4px solid var(--warning);
    }
    
    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .match-user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .match-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .match-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 500;
    }
    
    .match-type.bidirectional {
      background: rgba(39, 174, 96, 0.2);
      color: var(--success);
    }
    
    .match-type.they_have {
      background: rgba(52, 152, 219, 0.2);
      color: var(--secondary);
    }
    
    .match-type.they_want {
      background: rgba(243, 156, 18, 0.2);
      color: var(--warning);
    }
    
    .match-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .match-cards-section h5 {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    .match-card-list {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .match-card-mini {
      width: 60px;
      height: 84px;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }
    
    .match-card-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .match-card-mini .card-value {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      font-size: 0.65rem;
      text-align: center;
      padding: 2px;
    }
    
    .match-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    
    .match-values {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
    }
    
    .fairness-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .fairness-great { background: var(--success); color: white; }
    .fairness-good { background: var(--warning); color: black; }
    .fairness-poor { background: var(--danger); color: white; }
    
    .trade-card-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .trade-card-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      background: var(--bg-input);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .trade-card-item img {
      width: 40px;
      height: 56px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .trade-card-item .card-details {
      flex: 1;
    }
    
    .trade-card-item .card-name {
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .trade-card-item .card-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .trade-card-item .card-price {
      font-weight: bold;
      color: var(--success);
    }
    
    .trade-card-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    
    .trade-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .trade-item:hover {
      border-color: var(--primary);
    }
    
    .trade-item.status-pending { border-left: 4px solid var(--warning); }
    .trade-item.status-completed { border-left: 4px solid var(--success); }
    .trade-item.status-rejected { border-left: 4px solid var(--danger); }
    .trade-item.status-cancelled { border-left: 4px solid var(--text-muted); }
    
    .trade-status {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .trade-status.pending { background: var(--warning); color: black; }
    .trade-status.completed { background: var(--success); color: white; }
    .trade-status.rejected { background: var(--danger); color: white; }
    .trade-status.cancelled { background: var(--text-muted); color: black; }

    /* Category Switcher */
    .category-switcher {
      display: flex;
      gap: 0.75rem;
      background: var(--bg-input);
      padding: 0.5rem;
      border-radius: 12px;
    }
    
    .category-group {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding-right: 0.75rem;
      border-right: 1px solid var(--border);
    }
    
    .category-group:last-child {
      border-right: none;
      padding-right: 0;
    }
    
    .category-group-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 0.5rem;
      white-space: nowrap;
    }
    
    .category-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 0.4rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .category-btn:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .category-btn.active {
      background: var(--primary);
      color: white;
    }
    
    .category-btn.active[data-category="pokemon"] {
      background: #ffcb05;
      color: #1a1a2e;
    }
    
    .category-btn.active[data-category="mtg"] {
      background: #9b59b6;
      color: white;
    }
    
    .category-btn.active[data-category="yugioh"] {
      background: #e74c3c;
      color: white;
    }
    
    .category-btn.active[data-category="baseball"] {
      background: #c41e3a;
      color: white;
    }
    
    .category-btn.active[data-category="basketball"] {
      background: #fd5a1e;
      color: white;
    }
    
    .category-btn.active[data-category="football"] {
      background: #013369;
      color: white;
    }
    
    .category-btn span {
      font-size: 1rem;
    }
    
    @media (max-width: 1200px) {
      .category-switcher {
        flex-wrap: wrap;
      }
      .category-group {
        border-right: none;
        padding-right: 0;
      }
      .category-group-label {
        display: none;
      }
    }
    
    /* Category badges on cards */
    .card-category-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .card-category-badge.pokemon { background: #ffcb05; color: #1a1a2e; }
    .card-category-badge.mtg { background: #9b59b6; color: white; }
    .card-category-badge.yugioh { background: #e74c3c; color: white; }

    /* MTG-specific card info */
    .mtg-mana-cost {
      display: inline-flex;
      gap: 2px;
      margin-left: 0.5rem;
    }
    
    .mtg-type-line {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Yu-Gi-Oh-specific card info */
    .yugioh-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .yugioh-stats span {
      color: var(--warning);
      font-weight: bold;
    }

    /* Sports card specific styles */
    .sports-card-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.5rem;
      align-items: center;
      font-size: 0.8rem;
    }
    
    .sports-card-info .player-name {
      color: var(--text);
      font-weight: 500;
      width: 100%;
    }
    
    .sports-card-info .card-year {
      color: var(--text-muted);
      font-size: 0.75rem;
    }
    
    .rookie-badge {
      background: linear-gradient(135deg, #ffd700, #ffb700);
      color: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .grade-badge {
      background: var(--bg-input);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .grade-badge.psa {
      border-color: #e00000;
      color: #e00000;
    }
    
    .grade-badge.bgs {
      border-color: #0066cc;
      color: #0066cc;
    }
    
    .grade-badge.sgc {
      border-color: #00a86b;
      color: #00a86b;
    }
    
    .grade-badge.cgc {
      border-color: #9b59b6;
      color: #9b59b6;
    }

    /* Sports category colors */
    .card-category-badge.baseball { background: #c41e3a; }
    .card-category-badge.basketball { background: #fd5a1e; }
    .card-category-badge.football { background: #013369; }
    
    /* Graded prices table */
    .graded-prices {
      margin-top: 1rem;
      background: var(--bg-input);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .graded-prices h4 {
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    
    .graded-prices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1px;
      background: var(--border);
    }
    
    .grade-price-item {
      padding: 0.5rem;
      text-align: center;
      background: var(--bg-input);
    }
    
    .grade-price-item .grade {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .grade-price-item .price {
      font-size: 1rem;
      font-weight: bold;
      color: var(--success);
    }
    
    .grade-price-item .price.null {
      color: var(--text-muted);
      font-weight: normal;
    }
    
    /* Population report */
    .population-report {
      margin-top: 1rem;
    }
    
    .population-report h4 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .pop-grader-section {
      background: var(--bg-input);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }
    
    .pop-grader-header {
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      font-weight: bold;
      font-size: 0.85rem;
    }
    
    .pop-grades {
      display: flex;
      flex-wrap: wrap;
      padding: 0.5rem;
      gap: 0.5rem;
    }
    
    .pop-grade-item {
      background: var(--bg-card);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    
    .pop-grade-item .grade {
      color: var(--text-muted);
    }
    
    .pop-grade-item .pop {
      color: var(--primary);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" onclick="showPage('dashboard')">
      <span>üé¥</span>
      Card Collector Pro
    </div>
    
    <!-- Category Switcher -->
    <div id="categorySwitcher" class="category-switcher" style="display: none;">
      <div class="category-group">
        <span class="category-group-label">TCG</span>
        <button class="category-btn active" data-category="pokemon" onclick="switchCategory('pokemon')">
          <span>‚ö°</span> Pok√©mon
        </button>
        <button class="category-btn" data-category="mtg" onclick="switchCategory('mtg')">
          <span>üîÆ</span> MTG
        </button>
        <button class="category-btn" data-category="yugioh" onclick="switchCategory('yugioh')">
          <span>üé¥</span> Yu-Gi-Oh
        </button>
      </div>
      <div class="category-group">
        <span class="category-group-label">Sports</span>
        <button class="category-btn" data-category="baseball" onclick="switchCategory('baseball')">
          <span>‚öæ</span> Baseball
        </button>
        <button class="category-btn" data-category="basketball" onclick="switchCategory('basketball')">
          <span>üèÄ</span> Basketball
        </button>
        <button class="category-btn" data-category="football" onclick="switchCategory('football')">
          <span>üèà</span> Football
        </button>
      </div>
    </div>
    
    <nav id="mainNav" style="display: none;">
      <button data-page="dashboard" class="active">üìä Dashboard</button>
      <button data-page="search">üîç Search</button>
      <button data-page="collection">üì¶ Collection</button>
      <button data-page="want-list">üí´ Want List</button>
      <button data-page="trades">üîÑ Trades</button>
      <button data-page="sets">üìö Sets</button>
    </nav>
    
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="stats-bar">
        <div class="stat">
          <span>Cards:</span>
          <span class="stat-value" id="statCards">0</span>
        </div>
        <div class="stat">
          <span>Value:</span>
          <span class="stat-value" id="statValue">$0</span>
        </div>
      </div>
      <span id="userName"></span>
      <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
    </div>
  </header>
  
  <main>
    <!-- Auth Page -->
    <div class="page active" id="authPage">
      <div class="auth-container">
        <h2 id="authTitle">Welcome Back</h2>
        
        <form id="authForm">
          <div class="form-group" id="nameGroup" style="display: none;">
            <label>Name</label>
            <input type="text" id="nameInput" placeholder="Your name">
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="emailInput" placeholder="your@email.com" required>
          </div>
          
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          
          <button type="submit" class="btn btn-primary btn-full" id="authSubmit">Sign In</button>
        </form>
        
        <button class="btn google-btn btn-full" id="googleBtn" onclick="window.location='/auth/google'" style="display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>
        
        <div class="auth-toggle">
          <span id="authToggleText">Don't have an account?</span>
          <a onclick="toggleAuthMode()"><span id="authToggleLink">Sign Up</span></a>
        </div>
      </div>
    </div>
    
    <!-- Dashboard Page -->
    <div class="page" id="dashboardPage">
      <div class="page-header">
        <h1>üìä Portfolio Dashboard</h1>
        <div class="page-header-actions">
          <button class="btn btn-secondary btn-small" onclick="loadPortfolioStats()">‚Üª Refresh</button>
          <button class="btn btn-secondary btn-small" onclick="exportCollection()">üì• Export CSV</button>
          <button class="btn btn-primary btn-small" onclick="openShareModal()">üîó Share Collection</button>
        </div>
      </div>
      
      <div class="stats-grid" id="portfolioStats">
        <div class="stat-card">
          <div class="stat-label">Total Value</div>
          <div class="stat-value" id="dashTotalValue">$0.00</div>
          <div class="stat-change" id="dashDailyChange">+$0.00 today</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Cards</div>
          <div class="stat-value" id="dashUniqueCards">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Cards</div>
          <div class="stat-value" id="dashTotalCards">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ROI</div>
          <div class="stat-value" id="dashROI">0%</div>
          <div class="stat-change" id="dashProfit">$0 profit</div>
        </div>
      </div>
      
      <div class="two-col">
        <div class="chart-container">
          <h3>üìà Portfolio Value (30 Days)</h3>
          <canvas id="portfolioChart"></canvas>
        </div>
        
        <div class="chart-container">
          <h3>ü•ß Value by Set</h3>
          <canvas id="setChart"></canvas>
        </div>
      </div>
      
      <div class="two-col">
        <div>
          <h3 style="margin-bottom: 1rem;">üíé Most Valuable Cards</h3>
          <div id="topCardsContainer"></div>
        </div>
        
        <div>
          <h3 style="margin-bottom: 1rem;">üîÑ Trade Bait (Duplicates)</h3>
          <div id="duplicatesContainer"></div>
          <div id="duplicatesSummary" style="margin-top: 1rem; color: var(--text-muted);"></div>
        </div>
      </div>
    </div>
    
    <!-- Search Page -->
    <div class="page" id="searchPage">
      <div class="search-section">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Search for cards...">
          <button class="btn btn-primary" onclick="searchCards()">üîç Search</button>
        </div>
        <div id="searchPlaceholderText" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
          Searching in: <strong id="searchCategoryName">Pok√©mon TCG</strong>
        </div>
      </div>
      
      <div id="searchResults">
        <div class="empty-state">
          <div class="icon">üîé</div>
          <h3>Search for Cards</h3>
          <p id="searchEmptyText">Enter a card name to find it in the database</p>
        </div>
      </div>
    </div>
    
    <!-- Collection Page -->
    <div class="page" id="collectionPage">
      <div class="page-header">
        <h1>üì¶ My Collection</h1>
        <div class="page-header-actions">
          <span id="collectionTotal" style="color: var(--success); font-weight: bold;"></span>
          <button class="btn btn-secondary btn-small" onclick="exportCollection()">üì• Export</button>
        </div>
      </div>
      
      <div id="collectionResults">
        <div class="empty-state">
          <div class="icon">üì¶</div>
          <h3>Your Collection is Empty</h3>
          <p>Search for cards and add them to your collection!</p>
        </div>
      </div>
    </div>
    
    <!-- Want List Page -->
    <div class="page" id="wantListPage">
      <div class="page-header">
        <h1>üí´ Want List</h1>
      </div>
      
      <div id="wantListResults">
        <div class="empty-state">
          <div class="icon">üí´</div>
          <h3>Your Want List is Empty</h3>
          <p>Add cards you're looking for to track them!</p>
        </div>
      </div>
    </div>
    
    <!-- Trades Page -->
    <div class="page" id="tradesPage">
      <div class="page-header">
        <h1>üîÑ Trade Center</h1>
        <div id="tradeStats" class="stats-bar" style="display: flex; gap: 1.5rem;">
          <div class="stat"><span>Completed:</span> <span class="stat-value" id="tradeStatsCompleted">0</span></div>
          <div class="stat"><span>Pending:</span> <span class="stat-value" id="tradeStatsPending">0</span></div>
        </div>
      </div>
      
      <div class="tabs" id="tradeTabs">
        <button class="active" onclick="switchTradeTab('matches')">üéØ Find Matches</button>
        <button onclick="switchTradeTab('sent')">üì§ Sent (<span id="tradeSentCount">0</span>)</button>
        <button onclick="switchTradeTab('received')">üì• Received (<span id="tradeReceivedCount">0</span>)</button>
        <button onclick="switchTradeTab('history')">üìú History</button>
      </div>
      
      <!-- Find Matches Tab -->
      <div id="tradeMatchesTab" class="trade-tab">
        <div class="trade-info-box" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
          <h3 style="margin-bottom: 0.5rem;">ü§ù How Trade Matching Works</h3>
          <p style="color: var(--text-muted); font-size: 0.9rem;">
            We find users who have cards you want AND want cards you have (duplicates). 
            <strong style="color: var(--success);">Bidirectional matches</strong> are best - both parties get something they want!
          </p>
          <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem;">
            <div><span style="color: var(--text-muted);">Your Want List:</span> <strong id="matchWantCount">0</strong> cards</div>
            <div><span style="color: var(--text-muted);">Your Trade Bait:</span> <strong id="matchTradeableCount">0</strong> duplicates</div>
          </div>
        </div>
        
        <div id="matchResults">
          <div class="loading">Finding matches</div>
        </div>
      </div>
      
      <!-- Sent Trades Tab -->
      <div id="tradeSentTab" class="trade-tab" style="display: none;">
        <div id="sentTradesResults">
          <div class="loading">Loading sent trades</div>
        </div>
      </div>
      
      <!-- Received Trades Tab -->
      <div id="tradeReceivedTab" class="trade-tab" style="display: none;">
        <div id="receivedTradesResults">
          <div class="loading">Loading received trades</div>
        </div>
      </div>
      
      <!-- History Tab -->
      <div id="tradeHistoryTab" class="trade-tab" style="display: none;">
        <div id="historyTradesResults">
          <div class="loading">Loading trade history</div>
        </div>
      </div>
    </div>
    
    <!-- Sets Page -->
    <div class="page" id="setsPage">
      <div class="page-header">
        <h1 id="setsPageTitle">üìö Card Sets</h1>
      </div>
      
      <div class="search-bar" style="margin-bottom: 1.5rem;">
        <input type="text" id="setSearchInput" placeholder="Filter sets..." oninput="filterSets()">
      </div>
      
      <div id="setsResults">
        <div class="loading">Loading sets</div>
      </div>
    </div>
    
    <!-- Set Detail Page -->
    <div class="page" id="setDetailPage">
      <div class="page-header">
        <h1 id="setDetailTitle">Set Name</h1>
        <button class="btn btn-secondary" onclick="showPage('sets')">‚Üê Back to Sets</button>
      </div>
      
      <!-- Completion Stats -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;" id="setCompletionStats">
        <div class="stat-card">
          <div class="stat-label">Completion</div>
          <div class="stat-value" id="setCompletionPercent">0%</div>
          <div class="progress-bar progress-bar-large" style="margin-top: 0.5rem;">
            <div class="progress-bar-fill" id="setProgressFill" style="width: 0%;"></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cards Owned</div>
          <div class="stat-value" id="setOwnedCount">0/0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Owned Value</div>
          <div class="stat-value" id="setOwnedValue">$0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cost to Complete</div>
          <div class="stat-value" id="setCompletionCost">$0</div>
        </div>
      </div>
      
      <div class="tabs">
        <button class="active" onclick="switchSetTab('all')">All Cards</button>
        <button onclick="switchSetTab('missing')">Missing (<span id="missingCount">0</span>)</button>
        <button onclick="switchSetTab('owned')">Owned (<span id="ownedCount">0</span>)</button>
      </div>
      
      <div id="setDetailResults">
        <div class="loading">Loading cards</div>
      </div>
    </div>
    
    <!-- Public Collection Page (for shared links) -->
    <div class="page" id="publicCollectionPage">
      <div class="page-header">
        <h1 id="publicCollectionTitle">Collection</h1>
      </div>
      
      <div class="stats-grid" id="publicStats"></div>
      
      <div id="publicCollectionResults"></div>
    </div>
  </main>
  
  <!-- Card Detail Modal -->
  <div class="modal-overlay" id="cardModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalCardName">Card Name</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-card-detail">
          <img id="modalCardImage" src="" alt="">
          <div class="detail-info">
            <div class="detail-row">
              <span class="detail-label">Set</span>
              <span class="detail-value" id="modalCardSet">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Number</span>
              <span class="detail-value" id="modalCardNumber">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Rarity</span>
              <span class="detail-value" id="modalCardRarity">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Market Price</span>
              <span class="detail-value" id="modalCardPrice" style="color: var(--success);">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Artist</span>
              <span class="detail-value" id="modalCardArtist">-</span>
            </div>
            
            <!-- Price History Chart -->
            <div id="modalPriceHistory" style="margin-top: 1rem; display: none;">
              <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;">Price History (90 days)</h4>
              <canvas id="modalPriceChart" height="100"></canvas>
            </div>
            
            <!-- Sports Card Details (graded prices + population) -->
            <div id="modalSportsInfo" style="display: none; margin-top: 1rem;"></div>
            
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-success" id="modalAddCollection" onclick="addToCollection()">
                ‚ûï Add to Collection
              </button>
              <button class="btn btn-secondary" id="modalAddWantList" onclick="addToWantList()">
                üí´ Add to Want List
              </button>
            </div>
            
            <div id="modalTcgLinks" style="margin-top: 1rem;">
              <a id="tcgplayerLink" href="#" target="_blank" class="btn btn-secondary btn-small">View on TCGPlayer</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Share Modal -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>üîó Share Your Collection</h3>
        <button class="modal-close" onclick="closeShareModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 1rem;">
          Share your collection with others. They can view your cards but not make changes.
        </p>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="sharePublicToggle" onchange="toggleSharePublic()">
            Make my collection public
          </label>
        </div>
        
        <div id="shareUrlSection" style="display: none;">
          <div class="share-url">
            <input type="text" id="shareUrlInput" readonly>
            <button class="btn btn-primary" onclick="copyShareUrl()">üìã Copy</button>
          </div>
          
          <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary btn-small" onclick="shareToTwitter()">
              üê¶ Share on X
            </button>
            <button class="btn btn-secondary btn-small" onclick="shareToReddit()">
              üì¢ Share on Reddit
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Trade Proposal Modal -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3>üìù Propose Trade with <span id="tradeModalPartnerName"></span></h3>
        <button class="modal-close" onclick="closeTradeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="two-col" style="gap: 1.5rem;">
          <!-- What I'm offering -->
          <div>
            <h4 style="margin-bottom: 1rem; color: var(--warning);">üéÅ You're Offering</h4>
            <div id="tradeOfferCards" class="trade-card-list"></div>
            <div style="margin-top: 1rem; font-size: 0.9rem;">
              <span style="color: var(--text-muted);">Total Value:</span>
              <strong id="tradeOfferValue" style="color: var(--warning);">$0.00</strong>
            </div>
          </div>
          
          <!-- What I'm requesting -->
          <div>
            <h4 style="margin-bottom: 1rem; color: var(--success);">üéØ You're Requesting</h4>
            <div id="tradeRequestCards" class="trade-card-list"></div>
            <div style="margin-top: 1rem; font-size: 0.9rem;">
              <span style="color: var(--text-muted);">Total Value:</span>
              <strong id="tradeRequestValue" style="color: var(--success);">$0.00</strong>
            </div>
          </div>
        </div>
        
        <!-- Fairness indicator -->
        <div id="tradeFairnessBar" style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-input); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--text-muted);">Trade Fairness</span>
            <span id="tradeFairnessPercent" style="font-weight: bold;">100%</span>
          </div>
          <div class="progress-bar" style="width: 100%;">
            <div id="tradeFairnessFill" class="progress-bar-fill" style="width: 100%; background: var(--success);"></div>
          </div>
        </div>
        
        <!-- Message -->
        <div class="form-group" style="margin-top: 1rem;">
          <label>Message (optional)</label>
          <textarea id="tradeMessage" placeholder="Add a note to your trade proposal..." style="resize: vertical; min-height: 60px;"></textarea>
        </div>
        
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="closeTradeModal()">Cancel</button>
          <button class="btn btn-primary" id="submitTradeBtn" onclick="submitTrade()">üì§ Send Trade Proposal</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- View Trade Modal -->
  <div class="modal-overlay" id="viewTradeModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="viewTradeTitle">Trade Details</h3>
        <button class="modal-close" onclick="closeViewTradeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="viewTradeContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast">
    <span id="toastMessage"></span>
  </div>
  
  <script>
    // State
    let currentUser = null;
    let currentCard = null;
    let allSets = [];
    let myCollection = [];
    let myWantList = [];
    let currentSetData = null;
    let portfolioChart = null;
    let setChart = null;
    let modalPriceChart = null;
    let currentCategory = 'pokemon';
    let categories = [];
    
    // Category display names
    const CATEGORY_NAMES = {
      pokemon: 'Pok√©mon TCG',
      mtg: 'Magic: The Gathering',
      yugioh: 'Yu-Gi-Oh!',
      baseball: 'Baseball Cards',
      basketball: 'Basketball Cards',
      football: 'Football Cards'
    };
    
    const CATEGORY_ICONS = {
      pokemon: '‚ö°',
      mtg: 'üîÆ',
      yugioh: 'üé¥',
      baseball: '‚öæ',
      basketball: 'üèÄ',
      football: 'üèà'
    };
    
    const CATEGORY_COLORS = {
      pokemon: '#ffcb05',
      mtg: '#9b59b6',
      yugioh: '#e74c3c',
      baseball: '#c41e3a',
      basketball: '#fd5a1e',
      football: '#013369'
    };
    
    // Sports categories for special handling
    const SPORTS_CATEGORIES = ['baseball', 'basketball', 'football'];
    
    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Check if viewing public collection
      const path = window.location.pathname;
      if (path.startsWith('/c/')) {
        const token = path.split('/c/')[1];
        loadPublicCollection(token);
        return;
      }
      
      checkAuth();
      checkGoogleAuth();
      
      // Enter key for search
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchCards();
      });
      
      // Nav buttons
      document.querySelectorAll('nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.dataset.page;
          showPage(page);
        });
      });
      
      // Auth form
      document.getElementById('authForm').addEventListener('submit', handleAuth);
      
      // Close modals on overlay click
      document.getElementById('cardModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });
      document.getElementById('shareModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeShareModal();
      });
    });
    
    // Auth
    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          const data = await res.json();
          currentUser = data.user;
          onLogin(data);
        }
      } catch (e) {}
    }
    
    async function checkGoogleAuth() {
      try {
        const res = await fetch('/api/auth/providers');
        const data = await res.json();
        if (data.google) {
          document.getElementById('googleBtn').style.display = 'flex';
        }
      } catch (e) {}
    }
    
    let isSignUp = false;
    
    function toggleAuthMode() {
      isSignUp = !isSignUp;
      document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
      document.getElementById('nameGroup').style.display = isSignUp ? 'block' : 'none';
      document.getElementById('authSubmit').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('authToggleText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
      document.getElementById('authToggleLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    }
    
    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      const name = document.getElementById('nameInput').value;
      
      const endpoint = isSignUp ? '/api/signup' : '/api/login';
      const body = isSignUp ? { email, password, name } : { email, password };
      
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          showToast(data.error || 'Authentication failed', 'error');
          return;
        }
        
        checkAuth();
      } catch (e) {
        showToast('Network error', 'error');
      }
    }
    
    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      currentUser = null;
      document.getElementById('mainNav').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      showPage('auth');
      document.getElementById('authPage').classList.add('active');
    }
    
    function onLogin(data) {
      document.getElementById('authPage').classList.remove('active');
      document.getElementById('mainNav').style.display = 'flex';
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('categorySwitcher').style.display = 'flex';
      document.getElementById('userName').textContent = data.user.name;
      
      updateStats(data.stats);
      loadCategories();
      showPage('dashboard');
      loadCollection();
      loadWantList();
      loadSets();
      loadPortfolioStats();
    }
    
    // Load available categories from API
    async function loadCategories() {
      try {
        const res = await fetch('/api/categories');
        categories = await res.json();
      } catch (e) {
        console.error('Error loading categories:', e);
      }
    }
    
    // Switch between card categories (Pokemon, MTG, Yu-Gi-Oh)
    function switchCategory(category) {
      currentCategory = category;
      
      // Update category buttons
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === category);
      });
      
      // Update search placeholder
      document.getElementById('searchCategoryName').textContent = CATEGORY_NAMES[category] || category;
      
      // Update search input placeholder
      const placeholders = {
        pokemon: 'Search for Pokemon cards (e.g., Charizard, Pikachu)...',
        mtg: 'Search for Magic cards (e.g., Black Lotus, Lightning Bolt)...',
        yugioh: 'Search for Yu-Gi-Oh cards (e.g., Blue-Eyes, Dark Magician)...'
      };
      document.getElementById('searchInput').placeholder = placeholders[category] || 'Search for cards...';
      
      // Clear search results
      document.getElementById('searchResults').innerHTML = `
        <div class="empty-state">
          <div class="icon">${CATEGORY_ICONS[category] || 'üîé'}</div>
          <h3>Search ${CATEGORY_NAMES[category] || category} Cards</h3>
          <p>Enter a card name to search</p>
        </div>
      `;
      
      // Reload sets for new category
      loadSets();
      
      // Re-render collection and want list filtered by category
      renderCollection();
      renderWantList();
    }
    
    function updateStats(stats) {
      document.getElementById('statCards').textContent = stats?.totalQuantity || 0;
      document.getElementById('statValue').textContent = '$' + (stats?.totalValue || 0).toFixed(2);
    }
    
    // Navigation
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');
      
      // Update nav buttons
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === page);
      });
      
      // Load page-specific data
      if (page === 'dashboard') loadPortfolioStats();
    }
    
    // ============ PORTFOLIO DASHBOARD ============
    
    async function loadPortfolioStats() {
      try {
        const [statsRes, historyRes, duplicatesRes] = await Promise.all([
          fetch('/api/portfolio/stats'),
          fetch('/api/portfolio/history?days=30'),
          fetch('/api/collection/duplicates')
        ]);
        
        const stats = await statsRes.json();
        const history = await historyRes.json();
        const duplicates = await duplicatesRes.json();
        
        // Update stat cards
        document.getElementById('dashTotalValue').textContent = '$' + stats.totalValue.toFixed(2);
        document.getElementById('dashUniqueCards').textContent = stats.uniqueCards;
        document.getElementById('dashTotalCards').textContent = stats.totalCards;
        document.getElementById('dashROI').textContent = stats.roi.toFixed(1) + '%';
        
        const changeEl = document.getElementById('dashDailyChange');
        const changePrefix = stats.dailyChange >= 0 ? '+' : '';
        changeEl.textContent = `${changePrefix}$${stats.dailyChange.toFixed(2)} today (${changePrefix}${stats.dailyChangePercent.toFixed(1)}%)`;
        changeEl.className = `stat-change ${stats.dailyChange >= 0 ? 'positive' : 'negative'}`;
        
        const profitEl = document.getElementById('dashProfit');
        profitEl.textContent = `$${stats.profit.toFixed(2)} profit`;
        profitEl.className = `stat-change ${stats.profit >= 0 ? 'positive' : 'negative'}`;
        
        // Top cards
        const topCardsContainer = document.getElementById('topCardsContainer');
        if (stats.topCards && stats.topCards.length > 0) {
          topCardsContainer.innerHTML = stats.topCards.map(card => `
            <div class="list-item" onclick="openCardModal('${card.card_id}', true)">
              <img src="${card.card_image || ''}" alt="${card.card_name}">
              <div class="list-item-info">
                <div class="list-item-name">${card.card_name}</div>
                <div class="list-item-meta">${card.set_name || ''} ‚Ä¢ ${card.rarity || ''}</div>
              </div>
              <div style="text-align: right;">
                <div style="color: var(--success); font-weight: bold;">$${(card.total_value || 0).toFixed(2)}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">√ó${card.quantity}</div>
              </div>
            </div>
          `).join('');
        } else {
          topCardsContainer.innerHTML = '<p style="color: var(--text-muted);">No cards with prices yet</p>';
        }
        
        // Duplicates
        const duplicatesContainer = document.getElementById('duplicatesContainer');
        if (duplicates.duplicates && duplicates.duplicates.length > 0) {
          duplicatesContainer.innerHTML = duplicates.duplicates.slice(0, 5).map(card => `
            <div class="list-item">
              <img src="${card.card_image || ''}" alt="${card.card_name}">
              <div class="list-item-info">
                <div class="list-item-name">${card.card_name}</div>
                <div class="list-item-meta">${card.set_name || ''}</div>
              </div>
              <div style="text-align: right;">
                <div style="color: var(--warning); font-weight: bold;">√ó${card.trade_quantity} extra</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">$${(card.trade_value || 0).toFixed(2)} value</div>
              </div>
            </div>
          `).join('');
          document.getElementById('duplicatesSummary').textContent = 
            `Total trade bait: ${duplicates.totalTradeCards} cards worth $${duplicates.totalTradeValue.toFixed(2)}`;
        } else {
          duplicatesContainer.innerHTML = '<p style="color: var(--text-muted);">No duplicates yet</p>';
          document.getElementById('duplicatesSummary').textContent = '';
        }
        
        // Portfolio Chart
        renderPortfolioChart(history);
        
        // Set Chart
        renderSetChart(stats.bySet);
        
      } catch (e) {
        console.error('Error loading portfolio stats:', e);
      }
    }
    
    function renderPortfolioChart(history) {
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      
      if (portfolioChart) portfolioChart.destroy();
      
      const labels = history.map(h => h.snapshot_date);
      const values = history.map(h => h.total_value);
      
      portfolioChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Portfolio Value',
            data: values,
            borderColor: '#ff6b35',
            backgroundColor: 'rgba(255, 107, 53, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: { color: '#a0a0b0' },
              grid: { color: '#2a2a4a' }
            },
            x: {
              ticks: { color: '#a0a0b0', maxTicksLimit: 7 },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    function renderSetChart(bySet) {
      const ctx = document.getElementById('setChart').getContext('2d');
      
      if (setChart) setChart.destroy();
      
      const colors = ['#ff6b35', '#3498db', '#27ae60', '#f39c12', '#9b59b6', '#e74c3c', '#1abc9c', '#34495e', '#f1c40f', '#e91e63'];
      
      setChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: bySet.map(s => s.set_name || 'Unknown'),
          datasets: [{
            data: bySet.map(s => s.value),
            backgroundColor: colors.slice(0, bySet.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#ffffff', font: { size: 11 } }
            }
          }
        }
      });
    }
    
    // ============ SEARCH ============
    
    async function searchCards() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      
      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '<div class="loading">Searching</div>';
      
      try {
        // Use category-specific endpoint
        const res = await fetch(`/api/${currentCategory}/cards/search?q=${encodeURIComponent(query)}&pageSize=40`);
        const data = await res.json();
        
        if (data.data && data.data.length > 0) {
          renderCardGrid(data.data, resultsDiv, 'search');
        } else {
          resultsDiv.innerHTML = `
            <div class="empty-state">
              <div class="icon">${CATEGORY_ICONS[currentCategory] || 'üîé'}</div>
              <h3>No Cards Found</h3>
              <p>Try a different search term in ${CATEGORY_NAMES[currentCategory]}</p>
            </div>
          `;
        }
      } catch (e) {
        console.error('Search error:', e);
        resultsDiv.innerHTML = '<div class="empty-state"><h3>Error searching cards</h3><p>' + e.message + '</p></div>';
      }
    }
    
    // Render card grid
    function renderCardGrid(cards, container, context = 'search') {
      const collectionIds = new Set(myCollection.map(c => c.card_id));
      const wantListIds = new Set(myWantList.map(c => c.card_id));
      
      container.innerHTML = `<div class="card-grid">${cards.map(card => {
        const cardId = card.id || card.card_id;
        const category = card.category || currentCategory;
        const inCollection = collectionIds.has(cardId);
        const onWantList = wantListIds.has(cardId);
        const imageUrl = card.images?.small || card.card_image || '';
        const price = card.prices?.market || 
                     card.tcgplayer?.prices?.holofoil?.market || 
                     card.tcgplayer?.prices?.normal?.market ||
                     card.tcgplayer?.prices?.reverseHolofoil?.market ||
                     card.market_price || card.price || null;
        const quantity = card.quantity || 0;
        
        // Show category badge in collection/want-list views
        const showCategoryBadge = context === 'collection' || context === 'want-list';
        
        return `
          <div class="card-item" onclick="openCardModal('${cardId}', ${context === 'collection' || context === 'want-list' ? 'true' : 'false'}, '${category}')">
            ${quantity > 1 ? `<div class="card-quantity">√ó${quantity}</div>` : ''}
            ${showCategoryBadge ? `<div class="card-category-badge ${category}">${CATEGORY_ICONS[category] || 'üé¥'}</div>` : ''}
            ${inCollection && context !== 'collection' ? `<div class="card-owned-badge">‚úì Owned</div>` : ''}
            <img src="${imageUrl}" alt="${card.name || card.card_name}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22><rect fill=%22%231a1a2e%22 width=%22200%22 height=%22280%22/><text fill=%22%23666%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22>No Image</text></svg>'">
            <div class="card-info">
              <div class="card-name">${card.name || card.card_name}</div>
              <div class="card-set">${card.set?.name || card.set_name || ''} ${card.number ? '#' + card.number : ''}</div>
              ${category === 'mtg' && card.type_line ? `<div class="mtg-type-line">${card.type_line}</div>` : ''}
              ${category === 'yugioh' && (card.atk !== undefined || card.def !== undefined) ? `
                <div class="yugioh-stats">
                  ${card.atk !== undefined ? `ATK: <span>${card.atk}</span>` : ''}
                  ${card.def !== undefined ? `DEF: <span>${card.def}</span>` : ''}
                </div>
              ` : ''}
              ${SPORTS_CATEGORIES.includes(category) ? `
                <div class="sports-card-info">
                  ${card.playerName || card.player_name ? `<div class="player-name">üë§ ${card.playerName || card.player_name}</div>` : ''}
                  ${card.year ? `<div class="card-year">${card.year}</div>` : ''}
                  ${card.rookieCard || card.rookie_card ? `<span class="rookie-badge">RC</span>` : ''}
                  ${card.grade || card.grader ? `<div class="grade-badge ${(card.grader || '').toLowerCase()}">${card.grader || ''} ${card.grade || ''}</div>` : ''}
                </div>
              ` : ''}
              ${price ? `<div class="card-price">$${typeof price === 'number' ? price.toFixed(2) : price}</div>` : ''}
              ${context === 'collection' ? `
                <div class="card-actions">
                  <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeFromCollection(${card.id})">Remove</button>
                </div>
              ` : context === 'want-list' ? `
                <div class="card-actions">
                  <button class="btn btn-success btn-small" onclick="event.stopPropagation(); markAcquired(${card.id})">Got It!</button>
                  <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeFromWantList(${card.id})">‚úï</button>
                </div>
              ` : `
                <div class="card-actions">
                  ${!inCollection ? `<button class="btn btn-success btn-small" onclick="event.stopPropagation(); quickAdd('${cardId}', '${category}')">+ Add</button>` : ''}
                  ${!onWantList && !inCollection ? `<button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); quickWant('${cardId}', '${category}')">Want</button>` : ''}
                </div>
              `}
            </div>
          </div>
        `;
      }).join('')}</div>`;
    }
    
    // Modal
    async function openCardModal(cardId, isLocal = false, category = null) {
      try {
        let card;
        const cardCategory = category || currentCategory;
        
        if (isLocal) {
          card = myCollection.find(c => c.card_id === cardId || c.id == cardId) ||
                 myWantList.find(c => c.card_id === cardId || c.id == cardId);
          if (card) {
            const cat = card.category || cardCategory;
            const res = await fetch(`/api/${cat}/cards/${card.card_id}`);
            const data = await res.json();
            if (data.data) card = { ...data.data, ...card };
          }
        } else {
          const res = await fetch(`/api/${cardCategory}/cards/${cardId}`);
          const data = await res.json();
          card = data.data;
        }
        
        if (!card) return;
        
        // Ensure category is set
        card.category = card.category || cardCategory;
        currentCard = card;
        
        document.getElementById('modalCardName').textContent = card.name || card.card_name;
        document.getElementById('modalCardImage').src = card.images?.large || card.images?.small || card.card_image || '';
        document.getElementById('modalCardSet').textContent = card.set?.name || card.set_name || '-';
        document.getElementById('modalCardNumber').textContent = card.number || '-';
        document.getElementById('modalCardRarity').textContent = card.rarity || '-';
        document.getElementById('modalCardArtist').textContent = card.artist || '-';
        
        const price = card.tcgplayer?.prices?.holofoil?.market || 
                     card.tcgplayer?.prices?.normal?.market ||
                     card.tcgplayer?.prices?.reverseHolofoil?.market ||
                     card.prices?.market ||
                     card.market_price || null;
        document.getElementById('modalCardPrice').textContent = price ? `$${price.toFixed(2)}` : '-';
        
        // Sports card specific info
        const sportsInfoDiv = document.getElementById('modalSportsInfo');
        if (SPORTS_CATEGORIES.includes(cardCategory) && sportsInfoDiv) {
          sportsInfoDiv.style.display = 'block';
          sportsInfoDiv.innerHTML = renderSportsCardDetails(card);
        } else if (sportsInfoDiv) {
          sportsInfoDiv.style.display = 'none';
        }
        
        // TCGPlayer link (or eBay for sports cards)
        if (card.tcgplayer?.url) {
          document.getElementById('tcgplayerLink').href = card.tcgplayer.url;
          document.getElementById('tcgplayerLink').style.display = 'inline-flex';
        } else if (SPORTS_CATEGORIES.includes(cardCategory)) {
          // Link to eBay search for sports cards
          const searchQuery = encodeURIComponent(`${card.name || card.card_name}`);
          document.getElementById('tcgplayerLink').href = `https://www.ebay.com/sch/i.html?_nkw=${searchQuery}&LH_Complete=1&LH_Sold=1`;
          document.getElementById('tcgplayerLink').textContent = 'üîç eBay Sold';
          document.getElementById('tcgplayerLink').style.display = 'inline-flex';
        } else {
          document.getElementById('tcgplayerLink').style.display = 'none';
        }
        
        // Update buttons based on status
        const inCollection = myCollection.some(c => c.card_id === (card.id || card.card_id));
        const onWantList = myWantList.some(c => c.card_id === (card.id || card.card_id));
        
        document.getElementById('modalAddCollection').style.display = inCollection ? 'none' : 'inline-flex';
        document.getElementById('modalAddWantList').style.display = (onWantList || inCollection) ? 'none' : 'inline-flex';
        
        // Load price history
        loadPriceHistory(card.id || card.card_id);
        
        document.getElementById('cardModal').classList.add('active');
      } catch (e) {
        showToast('Error loading card details', 'error');
      }
    }
    
    // Render sports card details (graded prices + population)
    function renderSportsCardDetails(card) {
      let html = '';
      
      // Player and Year info
      if (card.playerName || card.player_name || card.year || card.team) {
        html += `
          <div class="sports-card-header">
            ${card.playerName || card.player_name ? `<div class="player-name">üë§ <strong>${card.playerName || card.player_name}</strong></div>` : ''}
            ${card.team ? `<div class="team">${card.team}</div>` : ''}
            ${card.year ? `<div class="year">${card.year}</div>` : ''}
            ${card.rookieCard || card.rookie_card ? `<span class="rookie-badge">ROOKIE CARD</span>` : ''}
          </div>
        `;
      }
      
      // Graded prices
      const gp = card.gradedPrices || card.prices?.graded;
      if (gp) {
        html += `
          <div class="graded-prices">
            <h4>üí∞ Price by Grade</h4>
            <div class="graded-prices-grid">
              ${gp.raw ? `<div class="grade-price-item"><div class="grade">Raw</div><div class="price">$${formatPrice(gp.raw)}</div></div>` : ''}
        `;
        
        // PSA grades
        if (gp.psa) {
          const psaGrades = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1].filter(g => gp.psa[g]);
          for (const grade of psaGrades) {
            html += `<div class="grade-price-item"><div class="grade">PSA ${grade}</div><div class="price">$${formatPrice(gp.psa[grade])}</div></div>`;
          }
        }
        
        // BGS grades
        if (gp.bgs) {
          const bgsGrades = ['pristine', 10, 9.5, 9, 8.5, 8].filter(g => gp.bgs[g]);
          for (const grade of bgsGrades) {
            const label = grade === 'pristine' ? 'BGS 10 Black' : `BGS ${grade}`;
            html += `<div class="grade-price-item"><div class="grade">${label}</div><div class="price">$${formatPrice(gp.bgs[grade])}</div></div>`;
          }
        }
        
        // SGC grades
        if (gp.sgc) {
          const sgcGrades = [10, 9].filter(g => gp.sgc[g]);
          for (const grade of sgcGrades) {
            html += `<div class="grade-price-item"><div class="grade">SGC ${grade}</div><div class="price">$${formatPrice(gp.sgc[grade])}</div></div>`;
          }
        }
        
        html += `</div></div>`;
      }
      
      // Population reports
      if (card.populationReports && card.populationReports.length > 0) {
        const byGrader = {};
        for (const pop of card.populationReports) {
          if (!byGrader[pop.grader]) byGrader[pop.grader] = [];
          byGrader[pop.grader].push(pop);
        }
        
        const totalPop = card.populationReports.reduce((sum, p) => sum + (p.population || 0), 0);
        
        html += `
          <div class="population-report">
            <h4>üìä Population Report <span style="font-weight: normal; color: var(--text-muted);">(${totalPop.toLocaleString()} total graded)</span></h4>
        `;
        
        for (const [grader, pops] of Object.entries(byGrader)) {
          html += `
            <div class="pop-grader-section">
              <div class="pop-grader-header">${grader}</div>
              <div class="pop-grades">
          `;
          
          // Sort grades descending
          pops.sort((a, b) => parseFloat(b.grade) - parseFloat(a.grade));
          
          for (const pop of pops) {
            const popClass = pop.population < 50 ? 'rare' : (pop.population < 500 ? 'uncommon' : '');
            html += `<div class="pop-grade-item ${popClass}"><span class="grade">${pop.grade}:</span> <span class="pop">${(pop.population || 0).toLocaleString()}</span></div>`;
          }
          
          html += `</div></div>`;
        }
        
        html += `</div>`;
      }
      
      return html || '<p class="text-muted">No detailed pricing data available</p>';
    }
    
    function formatPrice(price) {
      if (!price) return '-';
      if (price >= 1000000) return (price / 1000000).toFixed(2) + 'M';
      if (price >= 1000) return (price / 1000).toFixed(1) + 'K';
      return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    async function loadPriceHistory(cardId) {
      try {
        const res = await fetch(`/api/cards/${cardId}/price-history?days=90`);
        const data = await res.json();
        
        const historyContainer = document.getElementById('modalPriceHistory');
        
        if (data.history && data.history.length >= 2) {
          historyContainer.style.display = 'block';
          
          const ctx = document.getElementById('modalPriceChart').getContext('2d');
          if (modalPriceChart) modalPriceChart.destroy();
          
          modalPriceChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.history.map(h => h.date),
              datasets: [{
                label: 'Price',
                data: data.history.map(h => h.price),
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } },
                x: { display: false }
              }
            }
          });
        } else {
          historyContainer.style.display = 'none';
        }
      } catch (e) {
        document.getElementById('modalPriceHistory').style.display = 'none';
      }
    }
    
    function closeModal() {
      document.getElementById('cardModal').classList.remove('active');
      currentCard = null;
    }
    
    // ============ COLLECTION ============
    
    async function loadCollection() {
      try {
        const res = await fetch('/api/collection');
        myCollection = await res.json();
        renderCollection();
      } catch (e) {}
    }
    
    function renderCollection() {
      const container = document.getElementById('collectionResults');
      
      if (myCollection.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <h3>Your Collection is Empty</h3>
            <p>Search for cards and add them to your collection!</p>
          </div>
        `;
        document.getElementById('collectionTotal').textContent = '';
        return;
      }
      
      const totalValue = myCollection.reduce((sum, c) => sum + (c.quantity * (c.market_price || 0)), 0);
      document.getElementById('collectionTotal').textContent = `${myCollection.length} unique cards ‚Ä¢ $${totalValue.toFixed(2)}`;
      
      renderCardGrid(myCollection, container, 'collection');
    }
    
    async function addToCollection() {
      if (!currentCard) return;
      
      const price = currentCard.prices?.market ||
                   currentCard.tcgplayer?.prices?.holofoil?.market || 
                   currentCard.tcgplayer?.prices?.normal?.market ||
                   currentCard.tcgplayer?.prices?.reverseHolofoil?.market || null;
      
      try {
        const res = await fetch('/api/collection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardId: currentCard.id,
            cardName: currentCard.name,
            cardImage: currentCard.images?.small || currentCard.images?.large,
            setId: currentCard.set?.id,
            setName: currentCard.set?.name,
            rarity: currentCard.rarity,
            marketPrice: price,
            category: currentCard.category || currentCategory
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`Added ${currentCard.name} to collection!`, 'success');
          loadCollection();
          checkAuth();
          closeModal();
        } else {
          showToast(data.error || 'Failed to add card', 'error');
        }
      } catch (e) {
        showToast('Error adding card', 'error');
      }
    }
    
    async function quickAdd(cardId, category = null) {
      const cardCategory = category || currentCategory;
      try {
        const res = await fetch(`/api/${cardCategory}/cards/${cardId}`);
        const data = await res.json();
        const card = data.data;
        
        const price = card.prices?.market ||
                     card.tcgplayer?.prices?.holofoil?.market || 
                     card.tcgplayer?.prices?.normal?.market ||
                     card.tcgplayer?.prices?.reverseHolofoil?.market || null;
        
        const addRes = await fetch('/api/collection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardId: card.id,
            cardName: card.name,
            cardImage: card.images?.small || card.images?.large,
            setId: card.set?.id,
            setName: card.set?.name,
            rarity: card.rarity,
            marketPrice: price,
            category: cardCategory
          })
        });
        
        const result = await addRes.json();
        
        if (result.success) {
          showToast(`Added ${card.name}!`, 'success');
          loadCollection();
          checkAuth();
        }
      } catch (e) {
        showToast('Error adding card', 'error');
      }
    }
    
    async function removeFromCollection(id) {
      try {
        await fetch(`/api/collection/${id}`, { method: 'DELETE' });
        showToast('Card removed', 'success');
        loadCollection();
        checkAuth();
      } catch (e) {
        showToast('Error removing card', 'error');
      }
    }
    
    // ============ WANT LIST ============
    
    async function loadWantList() {
      try {
        const res = await fetch('/api/want-list');
        myWantList = await res.json();
        renderWantList();
      } catch (e) {}
    }
    
    function renderWantList() {
      const container = document.getElementById('wantListResults');
      
      if (myWantList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üí´</div>
            <h3>Your Want List is Empty</h3>
            <p>Add cards you're looking for to track them!</p>
          </div>
        `;
        return;
      }
      
      renderCardGrid(myWantList, container, 'want-list');
    }
    
    async function addToWantList() {
      if (!currentCard) return;
      
      try {
        const res = await fetch('/api/want-list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardId: currentCard.id,
            cardName: currentCard.name,
            cardImage: currentCard.images?.small || currentCard.images?.large,
            setId: currentCard.set?.id,
            setName: currentCard.set?.name,
            rarity: currentCard.rarity,
            category: currentCard.category || currentCategory
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`Added ${currentCard.name} to want list!`, 'success');
          loadWantList();
          checkAuth();
          closeModal();
        } else {
          showToast(data.error || 'Failed to add card', 'error');
        }
      } catch (e) {
        showToast('Error adding card', 'error');
      }
    }
    
    async function quickWant(cardId, category = null) {
      const cardCategory = category || currentCategory;
      try {
        const res = await fetch(`/api/${cardCategory}/cards/${cardId}`);
        const data = await res.json();
        const card = data.data;
        
        const addRes = await fetch('/api/want-list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardId: card.id,
            cardName: card.name,
            cardImage: card.images?.small || card.images?.large,
            setId: card.set?.id,
            setName: card.set?.name,
            rarity: card.rarity,
            category: cardCategory
          })
        });
        
        const result = await addRes.json();
        
        if (result.success) {
          showToast(`Added ${card.name} to want list!`, 'success');
          loadWantList();
          checkAuth();
        }
      } catch (e) {
        showToast('Error adding card', 'error');
      }
    }
    
    async function removeFromWantList(id) {
      try {
        await fetch(`/api/want-list/${id}`, { method: 'DELETE' });
        showToast('Card removed', 'success');
        loadWantList();
        checkAuth();
      } catch (e) {
        showToast('Error removing card', 'error');
      }
    }
    
    async function markAcquired(id) {
      try {
        await fetch(`/api/want-list/${id}/acquired`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ condition: 'Near Mint' })
        });
        showToast('Card moved to collection!', 'success');
        loadWantList();
        loadCollection();
        checkAuth();
      } catch (e) {
        showToast('Error moving card', 'error');
      }
    }
    
    // ============ SETS ============
    
    async function loadSets() {
      // Update page title for current category
      document.getElementById('setsPageTitle').innerHTML = `üìö ${CATEGORY_NAMES[currentCategory] || 'Card'} Sets`;
      
      try {
        const res = await fetch(`/api/${currentCategory}/sets`);
        const data = await res.json();
        allSets = data.data || [];
        renderSets(allSets);
      } catch (e) {
        console.error('Error loading sets:', e);
        document.getElementById('setsResults').innerHTML = `
          <div class="empty-state">
            <div class="icon">${CATEGORY_ICONS[currentCategory] || 'üìö'}</div>
            <h3>Error loading ${CATEGORY_NAMES[currentCategory]} sets</h3>
            <p>${e.message || 'Please try again later'}</p>
          </div>
        `;
      }
    }
    
    function filterSets() {
      const query = document.getElementById('setSearchInput').value.toLowerCase();
      const filtered = allSets.filter(s => s.name.toLowerCase().includes(query));
      renderSets(filtered);
    }
    
    async function renderSets(sets) {
      const container = document.getElementById('setsResults');
      
      let collectionBySet = {};
      try {
        const res = await fetch('/api/collection/by-set');
        const data = await res.json();
        data.forEach(s => collectionBySet[s.set_id] = s);
      } catch (e) {}
      
      container.innerHTML = `<div class="set-grid">${sets.map(set => {
        const owned = collectionBySet[set.id]?.unique_cards || 0;
        const total = set.total || set.printedTotal || 100;
        const pct = Math.round((owned / total) * 100);
        
        return `
          <div class="set-item" onclick="openSetDetail('${set.id}')">
            <img src="${set.images?.logo || set.images?.symbol}" alt="${set.name}">
            <div class="set-info">
              <div class="set-name">${set.name}</div>
              <div class="set-meta">${set.releaseDate || ''} ‚Ä¢ ${total} cards</div>
            </div>
            <div class="set-progress">
              <div style="font-size: 0.9rem;">${owned}/${total}</div>
              <div class="progress-bar">
                <div class="progress-bar-fill" style="width: ${pct}%; ${pct === 100 ? 'background: var(--success);' : ''}"></div>
              </div>
            </div>
          </div>
        `;
      }).join('')}</div>`;
    }
    
    async function openSetDetail(setId) {
      showPage('setDetail');
      
      const container = document.getElementById('setDetailResults');
      container.innerHTML = '<div class="loading">Loading set data</div>';
      
      try {
        // Get set info
        const setRes = await fetch(`/api/sets/${setId}`);
        const setData = await setRes.json();
        const set = setData.data;
        
        document.getElementById('setDetailTitle').textContent = set.name;
        
        // Get completion data
        const completionRes = await fetch(`/api/sets/${setId}/completion`);
        currentSetData = await completionRes.json();
        
        // Update stats
        document.getElementById('setCompletionPercent').textContent = currentSetData.completionPercent + '%';
        document.getElementById('setProgressFill').style.width = currentSetData.completionPercent + '%';
        document.getElementById('setOwnedCount').textContent = `${currentSetData.ownedCount}/${currentSetData.totalCards}`;
        document.getElementById('setOwnedValue').textContent = '$' + currentSetData.ownedValue.toFixed(2);
        document.getElementById('setCompletionCost').textContent = '$' + currentSetData.completionCost.toFixed(2);
        document.getElementById('missingCount').textContent = currentSetData.missingCount;
        document.getElementById('ownedCount').textContent = currentSetData.ownedCount;
        
        // Get all cards
        const cardsRes = await fetch(`/api/sets/${setId}/cards?pageSize=250`);
        const cardsData = await cardsRes.json();
        currentSetData.allCards = cardsData.data || [];
        
        // Default to all cards view
        switchSetTab('all');
        
      } catch (e) {
        container.innerHTML = '<div class="empty-state"><h3>Error loading set</h3></div>';
      }
    }
    
    function switchSetTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tabs button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().startsWith(tab));
      });
      
      const container = document.getElementById('setDetailResults');
      
      if (!currentSetData) return;
      
      let cards = [];
      const ownedIds = new Set(currentSetData.ownedCards.map(c => c.id));
      
      if (tab === 'all') {
        cards = currentSetData.allCards;
      } else if (tab === 'missing') {
        cards = currentSetData.missingCards;
      } else if (tab === 'owned') {
        cards = currentSetData.allCards.filter(c => ownedIds.has(c.id));
      }
      
      if (cards.length > 0) {
        // Add owned status and format for renderCardGrid
        const formattedCards = cards.map(card => ({
          ...card,
          id: card.id,
          name: card.name,
          set: { name: currentSetData.setId },
          images: { small: card.image || card.images?.small },
          tcgplayer: { prices: { normal: { market: card.price } } }
        }));
        renderCardGrid(formattedCards, container, 'search');
      } else {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">${tab === 'missing' ? 'üéâ' : 'üì≠'}</div>
            <h3>${tab === 'missing' ? 'Set Complete!' : 'No cards'}</h3>
          </div>
        `;
      }
    }
    
    // ============ SHARING ============
    
    async function openShareModal() {
      try {
        const res = await fetch('/api/share/settings');
        const settings = await res.json();
        
        document.getElementById('sharePublicToggle').checked = settings.isPublic;
        
        if (settings.isPublic && settings.shareUrl) {
          document.getElementById('shareUrlSection').style.display = 'block';
          document.getElementById('shareUrlInput').value = window.location.origin + settings.shareUrl;
        } else {
          document.getElementById('shareUrlSection').style.display = 'none';
        }
        
        document.getElementById('shareModal').classList.add('active');
      } catch (e) {
        showToast('Error loading share settings', 'error');
      }
    }
    
    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('active');
    }
    
    async function toggleSharePublic() {
      try {
        const res = await fetch('/api/share/toggle', { method: 'POST' });
        const data = await res.json();
        
        if (data.isPublic) {
          document.getElementById('shareUrlSection').style.display = 'block';
          document.getElementById('shareUrlInput').value = window.location.origin + data.shareUrl;
          showToast('Collection is now public!', 'success');
        } else {
          document.getElementById('shareUrlSection').style.display = 'none';
          showToast('Collection is now private', 'success');
        }
      } catch (e) {
        showToast('Error updating share settings', 'error');
      }
    }
    
    function copyShareUrl() {
      const input = document.getElementById('shareUrlInput');
      input.select();
      document.execCommand('copy');
      showToast('Link copied!', 'success');
    }
    
    function shareToTwitter() {
      const url = document.getElementById('shareUrlInput').value;
      const text = `Check out my Pokemon card collection! üé¥`;
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
    }
    
    function shareToReddit() {
      const url = document.getElementById('shareUrlInput').value;
      const title = 'Check out my Pokemon card collection!';
      window.open(`https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
    }
    
    // ============ PUBLIC COLLECTION VIEW ============
    
    async function loadPublicCollection(token) {
      document.getElementById('mainNav').style.display = 'none';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('publicCollectionPage').classList.add('active');
      
      try {
        const res = await fetch(`/api/public/collection/${token}`);
        
        if (!res.ok) {
          document.getElementById('publicCollectionTitle').textContent = 'Collection Not Found';
          document.getElementById('publicCollectionResults').innerHTML = `
            <div class="empty-state">
              <div class="icon">üîí</div>
              <h3>This collection is private or doesn't exist</h3>
            </div>
          `;
          return;
        }
        
        const data = await res.json();
        
        document.getElementById('publicCollectionTitle').textContent = `${data.collector.name}'s Collection`;
        
        document.getElementById('publicStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Value</div>
            <div class="stat-value">$${data.stats.totalValue.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Unique Cards</div>
            <div class="stat-value">${data.stats.uniqueCards}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Cards</div>
            <div class="stat-value">${data.stats.totalCards}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Member Since</div>
            <div class="stat-value">${new Date(data.collector.memberSince).toLocaleDateString()}</div>
          </div>
        `;
        
        const container = document.getElementById('publicCollectionResults');
        
        if (data.collection.length > 0) {
          container.innerHTML = `<div class="card-grid">${data.collection.map(card => `
            <div class="card-item">
              ${card.quantity > 1 ? `<div class="card-quantity">√ó${card.quantity}</div>` : ''}
              <img src="${card.card_image || ''}" alt="${card.card_name}" loading="lazy">
              <div class="card-info">
                <div class="card-name">${card.card_name}</div>
                <div class="card-set">${card.set_name || ''}</div>
                ${card.market_price ? `<div class="card-price">$${card.market_price.toFixed(2)}</div>` : ''}
              </div>
            </div>
          `).join('')}</div>`;
        } else {
          container.innerHTML = '<div class="empty-state"><h3>No cards in this collection</h3></div>';
        }
        
      } catch (e) {
        document.getElementById('publicCollectionResults').innerHTML = '<div class="empty-state"><h3>Error loading collection</h3></div>';
      }
    }
    
    // ============ EXPORT ============
    
    function exportCollection() {
      window.location.href = '/api/collection/export';
    }
    
    // ============ TOAST ============
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // ============ TRADE MATCHING ============
    
    let currentTradePartner = null;
    let currentTradeOffer = [];
    let currentTradeRequest = [];
    let currentMatches = [];
    
    function switchTradeTab(tab) {
      document.querySelectorAll('#tradeTabs button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab) || 
          (tab === 'matches' && btn.textContent.includes('Find')));
      });
      
      document.querySelectorAll('.trade-tab').forEach(t => t.style.display = 'none');
      
      if (tab === 'matches') {
        document.getElementById('tradeMatchesTab').style.display = 'block';
        loadMatches();
      } else if (tab === 'sent') {
        document.getElementById('tradeSentTab').style.display = 'block';
        loadTrades('sent');
      } else if (tab === 'received') {
        document.getElementById('tradeReceivedTab').style.display = 'block';
        loadTrades('received');
      } else if (tab === 'history') {
        document.getElementById('tradeHistoryTab').style.display = 'block';
        loadTrades('history');
      }
    }
    
    async function loadMatches() {
      const container = document.getElementById('matchResults');
      container.innerHTML = '<div class="loading">Finding trade matches</div>';
      
      try {
        const res = await fetch('/api/matches');
        const data = await res.json();
        
        currentMatches = data.matches || [];
        
        document.getElementById('matchWantCount').textContent = data.myWantCount || 0;
        document.getElementById('matchTradeableCount').textContent = data.myTradeableCount || 0;
        
        if (currentMatches.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üîç</div>
              <h3>No Matches Found</h3>
              <p>To find trade partners:</p>
              <ul style="text-align: left; max-width: 400px; margin: 1rem auto; color: var(--text-muted);">
                <li>Add cards to your <strong>Want List</strong></li>
                <li>Have <strong>duplicate cards</strong> in your collection (quantity > 1)</li>
                <li>Wait for other collectors to sign up!</li>
              </ul>
            </div>
          `;
          return;
        }
        
        container.innerHTML = currentMatches.map(match => renderMatchCard(match)).join('');
        
      } catch (e) {
        container.innerHTML = '<div class="empty-state"><h3>Error loading matches</h3></div>';
      }
    }
    
    function renderMatchCard(match) {
      const matchTypeLabel = {
        'bidirectional': 'ü§ù Perfect Match',
        'they_have': 'üì¶ They Have',
        'they_want': 'üí´ They Want'
      }[match.matchType] || match.matchType;
      
      const fairnessClass = match.fairness >= 80 ? 'great' : match.fairness >= 50 ? 'good' : 'poor';
      
      return `
        <div class="match-card ${match.matchType}">
          <div class="match-header">
            <div class="match-user">
              <div class="match-avatar">${match.userName[0].toUpperCase()}</div>
              <div>
                <div style="font-weight: 600;">${match.userName}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Score: ${Math.round(match.score)}</div>
              </div>
            </div>
            <span class="match-type ${match.matchType}">${matchTypeLabel}</span>
          </div>
          
          <div class="match-cards">
            ${match.theyHave.length > 0 ? `
              <div class="match-cards-section">
                <h5>üéÅ They can give you:</h5>
                <div class="match-card-list">
                  ${match.theyHave.slice(0, 5).map(card => `
                    <div class="match-card-mini" title="${card.card_name}">
                      <img src="${card.card_image || ''}" alt="${card.card_name}">
                      ${card.max_price ? `<div class="card-value">$${card.max_price.toFixed(0)}</div>` : ''}
                    </div>
                  `).join('')}
                  ${match.theyHave.length > 5 ? `<div class="match-card-mini" style="display: flex; align-items: center; justify-content: center; background: var(--bg-input);">+${match.theyHave.length - 5}</div>` : ''}
                </div>
              </div>
            ` : '<div class="match-cards-section"><h5>üéÅ They can give you:</h5><p style="color: var(--text-muted); font-size: 0.85rem;">Browse their collection</p></div>'}
            
            ${match.theyWant.length > 0 ? `
              <div class="match-cards-section">
                <h5>üí´ They want from you:</h5>
                <div class="match-card-list">
                  ${match.theyWant.slice(0, 5).map(card => `
                    <div class="match-card-mini" title="${card.card_name}">
                      <img src="${card.card_image || ''}" alt="${card.card_name}">
                      ${card.market_price ? `<div class="card-value">$${card.market_price.toFixed(0)}</div>` : ''}
                    </div>
                  `).join('')}
                  ${match.theyWant.length > 5 ? `<div class="match-card-mini" style="display: flex; align-items: center; justify-content: center; background: var(--bg-input);">+${match.theyWant.length - 5}</div>` : ''}
                </div>
              </div>
            ` : '<div class="match-cards-section"><h5>üí´ They want from you:</h5><p style="color: var(--text-muted); font-size: 0.85rem;">No specific cards</p></div>'}
          </div>
          
          <div class="match-footer">
            <div class="match-values">
              <div>
                <span style="color: var(--text-muted);">They offer:</span>
                <strong style="color: var(--success);">$${match.theyOfferValue.toFixed(2)}</strong>
              </div>
              <div>
                <span style="color: var(--text-muted);">You offer:</span>
                <strong style="color: var(--warning);">$${match.iOfferValue.toFixed(2)}</strong>
              </div>
              ${match.fairness !== null ? `
                <span class="fairness-badge fairness-${fairnessClass}">${match.fairness}% fair</span>
              ` : ''}
            </div>
            <button class="btn btn-primary" onclick="openTradeProposal(${match.userId}, '${match.userName}')">
              üìù Propose Trade
            </button>
          </div>
        </div>
      `;
    }
    
    async function openTradeProposal(userId, userName) {
      currentTradePartner = { userId, userName };
      currentTradeOffer = [];
      currentTradeRequest = [];
      
      document.getElementById('tradeModalPartnerName').textContent = userName;
      
      try {
        const res = await fetch(`/api/matches/${userId}/suggest`);
        const data = await res.json();
        
        // Render cards I can offer (they want these)
        const offerContainer = document.getElementById('tradeOfferCards');
        if (data.canOffer && data.canOffer.length > 0) {
          offerContainer.innerHTML = data.canOffer.map(card => `
            <div class="trade-card-item">
              <input type="checkbox" id="offer-${card.card_id}" onchange="toggleTradeCard('offer', '${card.card_id}', this.checked)">
              <img src="${card.card_image || ''}" alt="${card.card_name}">
              <div class="card-details">
                <div class="card-name">${card.card_name}</div>
                <div class="card-meta">${card.set_name || ''} ‚Ä¢ ${card.tradeable} available</div>
              </div>
              <div class="card-price">$${(card.market_price || 0).toFixed(2)}</div>
            </div>
          `).join('');
        } else {
          offerContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">No tradeable cards they want</p>';
        }
        
        // Render cards I can request (I want these, they have)
        const requestContainer = document.getElementById('tradeRequestCards');
        if (data.canRequest && data.canRequest.length > 0) {
          requestContainer.innerHTML = data.canRequest.map(card => `
            <div class="trade-card-item">
              <input type="checkbox" id="request-${card.card_id}" onchange="toggleTradeCard('request', '${card.card_id}', this.checked)">
              <img src="${card.card_image || ''}" alt="${card.card_name}">
              <div class="card-details">
                <div class="card-name">${card.card_name}</div>
                <div class="card-meta">${card.set_name || ''}</div>
              </div>
              <div class="card-price">$${(card.market_price || 0).toFixed(2)}</div>
            </div>
          `).join('');
        } else {
          requestContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">No cards you want that they have</p>';
        }
        
        // Store card data for trade submission
        window.tradeableCards = {
          canOffer: data.canOffer || [],
          canRequest: data.canRequest || []
        };
        
        updateTradeFairness();
        document.getElementById('tradeModal').classList.add('active');
        
      } catch (e) {
        showToast('Error loading trade options', 'error');
      }
    }
    
    function toggleTradeCard(type, cardId, checked) {
      const cards = type === 'offer' ? window.tradeableCards.canOffer : window.tradeableCards.canRequest;
      const card = cards.find(c => c.card_id === cardId);
      
      if (!card) return;
      
      const list = type === 'offer' ? currentTradeOffer : currentTradeRequest;
      
      if (checked) {
        list.push({
          cardId: card.card_id,
          cardName: card.card_name,
          cardImage: card.card_image,
          setName: card.set_name,
          rarity: card.rarity,
          marketPrice: card.market_price,
          quantity: 1
        });
      } else {
        const idx = list.findIndex(c => c.cardId === cardId);
        if (idx > -1) list.splice(idx, 1);
      }
      
      updateTradeFairness();
    }
    
    function updateTradeFairness() {
      const offerValue = currentTradeOffer.reduce((s, c) => s + (c.marketPrice || 0), 0);
      const requestValue = currentTradeRequest.reduce((s, c) => s + (c.marketPrice || 0), 0);
      
      document.getElementById('tradeOfferValue').textContent = '$' + offerValue.toFixed(2);
      document.getElementById('tradeRequestValue').textContent = '$' + requestValue.toFixed(2);
      
      let fairness = 100;
      if (offerValue > 0 || requestValue > 0) {
        const max = Math.max(offerValue, requestValue);
        const min = Math.min(offerValue, requestValue);
        fairness = max > 0 ? Math.round((min / max) * 100) : 100;
      }
      
      document.getElementById('tradeFairnessPercent').textContent = fairness + '%';
      document.getElementById('tradeFairnessFill').style.width = fairness + '%';
      document.getElementById('tradeFairnessFill').style.background = 
        fairness >= 80 ? 'var(--success)' : fairness >= 50 ? 'var(--warning)' : 'var(--danger)';
    }
    
    function closeTradeModal() {
      document.getElementById('tradeModal').classList.remove('active');
      currentTradePartner = null;
      currentTradeOffer = [];
      currentTradeRequest = [];
    }
    
    async function submitTrade() {
      if (currentTradeOffer.length === 0 && currentTradeRequest.length === 0) {
        showToast('Select at least one card to trade', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/trades', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            recipientId: currentTradePartner.userId,
            offeredCards: currentTradeOffer,
            requestedCards: currentTradeRequest,
            message: document.getElementById('tradeMessage').value
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Trade proposal sent!', 'success');
          closeTradeModal();
          switchTradeTab('sent');
        } else {
          showToast(data.error || 'Failed to send trade', 'error');
        }
      } catch (e) {
        showToast('Error sending trade', 'error');
      }
    }
    
    async function loadTrades(type) {
      let containerId, statusFilter;
      
      if (type === 'sent') {
        containerId = 'sentTradesResults';
        statusFilter = 'pending';
      } else if (type === 'received') {
        containerId = 'receivedTradesResults';
        statusFilter = 'pending';
      } else {
        containerId = 'historyTradesResults';
        statusFilter = 'all';
      }
      
      const container = document.getElementById(containerId);
      container.innerHTML = '<div class="loading">Loading trades</div>';
      
      try {
        const res = await fetch(`/api/trades?status=${statusFilter}`);
        let trades = await res.json();
        
        // Filter by direction
        if (type === 'sent') {
          trades = trades.filter(t => t.direction === 'sent' && t.status === 'pending');
          document.getElementById('tradeSentCount').textContent = trades.length;
        } else if (type === 'received') {
          trades = trades.filter(t => t.direction === 'received' && t.status === 'pending');
          document.getElementById('tradeReceivedCount').textContent = trades.length;
        } else {
          trades = trades.filter(t => t.status !== 'pending');
        }
        
        if (trades.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">${type === 'sent' ? 'üì§' : type === 'received' ? 'üì•' : 'üìú'}</div>
              <h3>No ${type} trades</h3>
            </div>
          `;
          return;
        }
        
        container.innerHTML = trades.map(trade => renderTradeItem(trade, type)).join('');
        
      } catch (e) {
        container.innerHTML = '<div class="empty-state"><h3>Error loading trades</h3></div>';
      }
    }
    
    function renderTradeItem(trade, context) {
      const isReceived = trade.direction === 'received';
      const partnerName = isReceived ? trade.proposer_name : trade.recipient_name;
      
      return `
        <div class="trade-item status-${trade.status}" onclick="viewTrade(${trade.id})">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div>
              <strong>${isReceived ? 'From' : 'To'}: ${partnerName}</strong>
              <div style="font-size: 0.8rem; color: var(--text-muted);">${new Date(trade.created_at).toLocaleDateString()}</div>
            </div>
            <span class="trade-status ${trade.status}">${trade.status}</span>
          </div>
          
          <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
            <div>
              <span style="color: var(--text-muted);">Offering:</span>
              <strong>${trade.offeredCards.length} cards ($${trade.proposer_value.toFixed(2)})</strong>
            </div>
            <div>
              <span style="color: var(--text-muted);">Requesting:</span>
              <strong>${trade.requestedCards.length} cards ($${trade.recipient_value.toFixed(2)})</strong>
            </div>
          </div>
          
          ${context === 'received' && trade.status === 'pending' ? `
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <button class="btn btn-success btn-small" onclick="event.stopPropagation(); handleTrade(${trade.id}, 'accept')">‚úì Accept</button>
              <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); handleTrade(${trade.id}, 'reject')">‚úï Reject</button>
            </div>
          ` : context === 'sent' && trade.status === 'pending' ? `
            <div style="margin-top: 1rem;">
              <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); handleTrade(${trade.id}, 'cancel')">Cancel Trade</button>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    async function viewTrade(tradeId) {
      try {
        const res = await fetch(`/api/trades/${tradeId}`);
        const trade = await res.json();
        
        const isReceived = trade.direction === 'received';
        const partnerName = isReceived ? trade.proposer_name : trade.recipient_name;
        
        document.getElementById('viewTradeTitle').textContent = `Trade with ${partnerName}`;
        
        document.getElementById('viewTradeContent').innerHTML = `
          <div style="margin-bottom: 1rem;">
            <span class="trade-status ${trade.status}" style="margin-right: 1rem;">${trade.status}</span>
            <span style="color: var(--text-muted);">${new Date(trade.created_at).toLocaleString()}</span>
          </div>
          
          ${trade.message ? `<div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><strong>Message:</strong> ${trade.message}</div>` : ''}
          
          <div class="two-col" style="gap: 1.5rem;">
            <div>
              <h4 style="margin-bottom: 1rem; color: var(--warning);">üéÅ ${isReceived ? 'They Offer' : 'You Offer'}</h4>
              ${trade.offeredCards.map(card => `
                <div class="trade-card-item">
                  <img src="${card.card_image || ''}" alt="${card.card_name}">
                  <div class="card-details">
                    <div class="card-name">${card.card_name}</div>
                    <div class="card-meta">${card.set_name || ''} √ó ${card.quantity}</div>
                  </div>
                  <div class="card-price">$${(card.market_price || 0).toFixed(2)}</div>
                </div>
              `).join('') || '<p style="color: var(--text-muted);">No cards</p>'}
              <div style="margin-top: 0.5rem; font-weight: bold;">Total: $${trade.proposer_value.toFixed(2)}</div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 1rem; color: var(--success);">üéØ ${isReceived ? 'They Request' : 'You Request'}</h4>
              ${trade.requestedCards.map(card => `
                <div class="trade-card-item">
                  <img src="${card.card_image || ''}" alt="${card.card_name}">
                  <div class="card-details">
                    <div class="card-name">${card.card_name}</div>
                    <div class="card-meta">${card.set_name || ''} √ó ${card.quantity}</div>
                  </div>
                  <div class="card-price">$${(card.market_price || 0).toFixed(2)}</div>
                </div>
              `).join('') || '<p style="color: var(--text-muted);">No cards</p>'}
              <div style="margin-top: 0.5rem; font-weight: bold;">Total: $${trade.recipient_value.toFixed(2)}</div>
            </div>
          </div>
          
          ${trade.status === 'pending' ? `
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
              ${isReceived ? `
                <button class="btn btn-success" onclick="handleTrade(${trade.id}, 'accept'); closeViewTradeModal();">‚úì Accept Trade</button>
                <button class="btn btn-danger" onclick="handleTrade(${trade.id}, 'reject'); closeViewTradeModal();">‚úï Reject</button>
              ` : `
                <button class="btn btn-secondary" onclick="handleTrade(${trade.id}, 'cancel'); closeViewTradeModal();">Cancel Trade</button>
              `}
            </div>
          ` : ''}
        `;
        
        document.getElementById('viewTradeModal').classList.add('active');
        
      } catch (e) {
        showToast('Error loading trade', 'error');
      }
    }
    
    function closeViewTradeModal() {
      document.getElementById('viewTradeModal').classList.remove('active');
    }
    
    async function handleTrade(tradeId, action) {
      try {
        const res = await fetch(`/api/trades/${tradeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          
          // Reload data
          if (action === 'accept') {
            loadCollection();
            loadWantList();
          }
          
          // Refresh trades
          loadTrades('sent');
          loadTrades('received');
          loadTradeStats();
        } else {
          showToast(data.error || 'Failed to process trade', 'error');
        }
      } catch (e) {
        showToast('Error processing trade', 'error');
      }
    }
    
    async function loadTradeStats() {
      try {
        const res = await fetch('/api/trades/stats');
        const stats = await res.json();
        
        document.getElementById('tradeStatsCompleted').textContent = stats.completedTrades || 0;
        document.getElementById('tradeStatsPending').textContent = 
          (stats.pendingSent || 0) + (stats.pendingReceived || 0);
      } catch (e) {}
    }
    
    // Load trades when visiting trades page
    const originalShowPage = showPage;
    showPage = function(page) {
      originalShowPage(page);
      if (page === 'trades') {
        switchTradeTab('matches');
        loadTradeStats();
      }
    };
  </script>
</body>
</html>
